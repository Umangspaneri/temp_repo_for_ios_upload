name: Build & Sign iOS App for App Store

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'

      - name: Install dependencies
        run: |
          set -euo pipefail
          flutter pub get --verbose 2>&1 | tee pubget.log
          gem install cocoapods --user-install
          export PATH="$HOME/.gem/ruby/3.0.0/bin:$PATH"
          cd ios && pod install --repo-update --silent && cd ..

      - name: Upload pubget log
        uses: actions/upload-artifact@v4
        with:
          name: pubget-log
          path: pubget.log

      - name: Build iOS release (no signing)
        run: |
          set -euo pipefail
          echo "üöß Building iOS release without signing‚Ä¶"
          flutter build ios --release --no-codesign --verbose 2>&1 | tee flutter_build.log || {
            echo "::error::‚ùå Flutter build failed. Last 50 lines:"
            tail -n50 flutter_build.log
            exit 1
          }

      - name: Archive with Xcode (manual signing)
        run: |
          set -euo pipefail
          echo "üì¶ Archiving with Xcode‚Ä¶"
          xcodebuild archive \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/ios/archive/Runner.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="Rentpedia_AppStore_2025" || {
              echo "::error::‚ùå Xcode archive failed. Check signing identity and profile name."
              exit 1
          }

      - name: Export signed .ipa
        run: |
          set -euo pipefail
          echo "üì§ Exporting signed IPA‚Ä¶"
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist certs/tmp.plist \
            -exportPath certs/ || {
              echo "::error::‚ùå IPA export failed. Check tmp.plist and signing setup."
              exit 1
          }

          echo "‚úÖ Signed IPA generated at: $(pwd)/certs/Runner.ipa"

      - name: Upload signed .ipa
        uses: actions/upload-artifact@v4
        with:
          name: signed-ios-ipa
          path: certs/Runner.ipa

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            pubget.log
            flutter_build.log
