# name: Build & Sign iOS App for App Store

# on:
#   push:
#     branches: [ main ]
#   workflow_dispatch:

# jobs:
#   build:
#     runs-on: macos-14
#     timeout-minutes: 120

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Setup Flutter
#         uses: subosito/flutter-action@v2
#         with:
#           flutter-version: '3.35.3'
#           channel: stable

#       - name: Select Xcode 16
#         run: |
#           echo "ðŸ”„ Selecting Xcode 16..."
#           X16=$(ls /Applications | grep '^Xcode_16' | head -n1)
#           if [ -z "$X16" ]; then
#             echo "::error::âŒ Xcode_16 not found"
#             exit 1
#           fi
#           sudo xcode-select -s /Applications/"$X16"/Contents/Developer
#           echo "âœ… Using: $(xcode-select -p)"

#       - name: Confirm Xcode version
#         run: xcodebuild -version

#       - name: Check Flutter & Dart versions
#         run: |
#           flutter --version
#           dart --version

#       - name: Install dependencies
#         run: |
#           flutter pub get --verbose 2>&1 | tee pubget.log || {
#             echo "::error::âŒ flutter pub get failed"
#             tail -n200 pubget.log
#             exit 1
#           }
#           gem install cocoapods --user-install 2>&1 | tee cocoapods_install.log || {
#             echo "::error::âŒ gem install cocoapods failed"
#             tail -n200 cocoapods_install.log
#             exit 1
#           }
#           export PATH="$HOME/.gem/ruby/3.0.0/bin:$PATH"
#           cd ios
#           pod install --repo-update --verbose 2>&1 | tee pod_install.log || {
#             echo "::error::âŒ pod install failed"
#             tail -n200 pod_install.log
#             exit 1
#           }
#           cd ..

#       - name: Upload dependency logs
#         uses: actions/upload-artifact@v4
#         with:
#           name: dependency-logs
#           path: |
#             pubget.log
#             cocoapods_install.log
#             ios/pod_install.log

#       - name: Import signing certificate
#         env:
#           CERT_PASS: ${{ secrets.IOS_CERT_PASSWORD }}
#         run: |
#           KEYCHAIN=build-temp.keychain
#           security create-keychain -p "" "$KEYCHAIN"
#           security set-keychain-settings -t 3600 -u "$KEYCHAIN"
#           security unlock-keychain -p "" "$KEYCHAIN"
#           security import certs/Certificates.p12 \
#             -k ~/Library/Keychains/"$KEYCHAIN"-db \
#             -P "$CERT_PASS" \
#             -T /usr/bin/codesign \
#             -T /usr/bin/security \
#           2>&1 | tee security_import.log || {
#             echo "::error::âŒ .p12 import failed"
#             tail -n200 security_import.log
#             exit 1
#           }
#           security list-keychains -d user -s ~/Library/Keychains/"$KEYCHAIN"-db $(security list-keychains -d user | tr -d '"') || true

#       - name: Decode and register provisioning profile
#         run: |
#           security cms -D -i certs/Rentpedia_AppStore_2025.mobileprovision > parsed_profile.plist || {
#             echo "::error::âŒ Failed to decode provisioning profile"
#             exit 1
#           }
#           PROFILE_UUID=$(plutil -extract UUID raw parsed_profile.plist 2>/dev/null || echo "")
#           if [ -z "$PROFILE_UUID" ]; then
#             echo "::error::âŒ No UUID found in provisioning profile"
#             exit 1
#           fi
#           mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
#           cp certs/Rentpedia_AppStore_2025.mobileprovision \
#             ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
#           echo "âœ… Registered profile UUID: $PROFILE_UUID"

#       - name: Verify profile registration
#         run: ls -l ~/Library/MobileDevice/Provisioning\ Profiles


#       - name: Upload decoded profile
#         uses: actions/upload-artifact@v4
#         with:
#           name: parsed-profile
#           path: parsed_profile.plist

#       - name: Check profile name and team ID
#         run: |
#           echo "ðŸ” Extracting profile name and team ID..."
#           plutil -extract Name raw parsed_profile.plist
#           plutil -extract TeamIdentifier raw parsed_profile.plist


#       - name: Ensure ExportOptions.plist
#         run: |
#           cat > ios/ExportOptions.plist <<EOF
#           <?xml version="1.0" encoding="UTF-8"?>
#           <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
#             "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
#           <plist version="1.0">
#           <dict>
#             <key>method</key><string>app-store</string>
#             <key>signingStyle</key><string>automatic</string>
#             <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
#           </dict>
#           </plist>
#           EOF

#       - name: Build iOS (flutter) -- no-codesign
#         run: |
#           flutter build ios --release --no-codesign --verbose 2>&1 | tee flutter_build.log || {
#             echo "::error::âŒ Flutter build failed"
#             tail -n200 flutter_build.log
#             exit 1
#           }

#       - name: Upload flutter build log
#         uses: actions/upload-artifact@v4
#         with:
#           name: flutter-build-log
#           path: flutter_build.log

#       - name: List available schemes
#         run: xcodebuild -list -workspace ios/Runner.xcworkspace

#       - name: Archive with Xcode
#         env:
#           DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
#           OTHER_CODE_SIGN_FLAGS: "--keychain $HOME/Library/Keychains/build-temp.keychain-db"
#         run: |
#           mkdir -p build/ios/archive
#           xcodebuild \
#             -workspace ios/Runner.xcworkspace \
#             -scheme Runner \
#             -configuration Release \
#             -sdk iphoneos \
#             -archivePath build/ios/archive/Runner.xcarchive \
#             -allowProvisioningUpdates \
#             CODE_SIGN_STYLE=Automatic \
#             # CODE_SIGN_IDENTITY="Apple Distribution" \
#             DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
#             OTHER_CODE_SIGN_FLAGS="$OTHER_CODE_SIGN_FLAGS" \
#           2>&1 | tee xcodebuild_archive.log || {
#             echo "::error::âŒ xcodebuild archive failed"
#             tail -n200 xcodebuild_archive.log
#             exit 1
#           }

#       - name: Upload xcodebuild archive log
#         uses: actions/upload-artifact@v4
#         with:
#           name: xcodebuild-archive-log
#           path: xcodebuild_archive.log

#       - name: Verify archive exists
#         run: |
#           if [ ! -d build/ios/archive/Runner.xcarchive ]; then
#             echo "::error::âŒ Archive not created"
#             exit 1
#           fi

#       - name: Export .ipa from archive
#         run: |
#           mkdir -p build/ios/ipa
#           xcodebuild -exportArchive \
#             -archivePath build/ios/archive/Runner.xcarchive \
#             -exportOptionsPlist ios/ExportOptions.plist \
#             -exportPath build/ios/ipa \
#           2>&1 | tee xcodebuild_export.log || {
#             echo "::error::âŒ xcodebuild export failed"
#             tail -n200 xcodebuild_export.log
#             exit 1
#           }

#       - name: List IPA folder contents
#         run: ls -l build/ios/ipa

#       - name: Upload xcodebuild export log
#         uses: actions/upload-artifact@v4
#         with:
#           name: xcodebuild-export-log
#           path: xcodebuild_export.log

#       # - name: Rename IPA to Rentpedia.ipa
#       #   run: mv build/ios/ipa/Runner.ipa build/ios/ipa/Rentpedia.ipa

#       - name: Upload signed IPA artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: signed-ios-ipa
#           path: build/ios/ipa/Rentpedia.ipa

#       - name: Verify IPA exists
#         run: |
#           if [ ! -f build/ios/ipa/Rentpedia.ipa ]; then
#             echo "::error::âŒ IPA not found before upload"
#             exit 1
#           fi

#       - name: Upload to TestFlight (altool)
#         env:
#           APPLE_ID: ${{ secrets.APPLE_ID }}
#           APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
#         run: |
#           xcrun altool --upload-app \
#             --type ios \
#             --file build/ios/ipa/Rentpedia.ipa \
#             --username "${{ secrets.APPLE_ID }}" \
#             --password "${{ secrets.APP_SPECIFIC_PASSWORD }}"


name: Build & Sign iOS App for App Store

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 120

    steps:
      # 1. Checkout source
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Flutter SDK
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'  # Fixed version number
          channel: stable

      # 3. Install Flutter & CocoaPods dependencies
      - name: Install dependencies
        run: |
          set -euo pipefail
          trap 'echo "::error::DEPENDENCY_INSTALL_ERROR at line $LINENO"; exit 1' ERR

          # Dart packages
          flutter pub get --verbose

          # CocoaPods
          gem install cocoapods --user-install
          export PATH="$HOME/.gem/ruby/3.0.0/bin:$PATH"
          cd ios
          pod install --repo-update --verbose
          cd ..

          echo "âœ… DEPENDENCY_INSTALL_SUCCESS"

      # 4. Select Xcode 16
      - name: Select Xcode 16
        run: |
          set -euo pipefail
          trap 'echo "::error::XCODE_SELECT_ERROR at line $LINENO"; exit 1' ERR

          X16=$(ls /Applications | grep '^Xcode_16' | head -n1)
          [ -n "$X16" ] || { echo "::error::XCODE_NOT_FOUND"; exit 1; }
          sudo xcode-select -s /Applications/"$X16"/Contents/Developer
          echo "âœ… XCODE_SELECT_SUCCESS using $X16"

      # 5. Setup temp keychain & import P12
      - name: Setup keychain & import P12
        env:
          CERT_PASS: ${{ secrets.IOS_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          trap 'echo "::error::KEYCHAIN_IMPORT_ERROR at line $LINENO"; exit 1' ERR

          KC=build-temp.keychain-db
          security create-keychain -p "" "$KC"
          security set-keychain-settings -t 3600 -u "$KC"
          security unlock-keychain -p "" "$KC"
          security import certs/Certificates.p12 \
            -k ~/Library/Keychains/"$KC" \
            -P "$CERT_PASS" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security list-keychains -d user -s \
            ~/Library/Keychains/"$KC" \
            $(security list-keychains -d user)

          echo "âœ… KEYCHAIN_IMPORT_SUCCESS"

      # 6. Grant codesign partition list
      - name: Allow codesign access
        run: |
          set -euo pipefail
          trap 'echo "::error::PARTITION_LIST_ERROR at line $LINENO"; exit 1' ERR

          security set-key-partition-list \
            -S apple-tool:,apple-tool:codesign: \
            -s -k "" ~/Library/Keychains/build-temp.keychain-db

          echo "âœ… PARTITION_LIST_SUCCESS"

      # 7. Debug and extract Distribution identity - FIXED VERSION
      - name: Extract Distribution identity
        run: |
          set -euo pipefail
          trap 'echo "::error::DIST_ID_EXTRACT_ERROR at line $LINENO"; exit 1' ERR

          echo "=== All available identities ==="
          security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db

          # Try multiple patterns to find distribution certificate
          DIST_ID=""
          
          # Pattern 1: Standard iPhone Distribution format
          DIST_ID=$(security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db \
            | grep 'iPhone Distribution:' | head -n1 \
            | sed -E 's/^[[:space:]]*[0-9]+\) [A-F0-9]+ \"(.+)\".*$/\1/' || true)
          
          # Pattern 2: Distribution format (like your provisioning profile)
          if [ -z "$DIST_ID" ]; then
            DIST_ID=$(security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db \
              | grep 'Distribution' | head -n1 \
              | sed -E 's/^[[:space:]]*[0-9]+\) [A-F0-9]+ \"(.+)\".*$/\1/' || true)
          fi
          
          # Pattern 3: Apple Distribution format
          if [ -z "$DIST_ID" ]; then
            DIST_ID=$(security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db \
              | grep 'Apple Distribution' | head -n1 \
              | sed -E 's/^[[:space:]]*[0-9]+\) [A-F0-9]+ \"(.+)\".*$/\1/' || true)
          fi

          [ -n "$DIST_ID" ] || { 
            echo "::error::NO_DIST_ID_FOUND - Available certificates:"
            security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db
            exit 1
          }
          
          echo "CODE_SIGN_IDENTITY=$DIST_ID" >> $GITHUB_ENV
          echo "âœ… DIST_ID_EXTRACT_SUCCESS: $DIST_ID"

      # 8. Register provisioning profile
      - name: Register provisioning profile
        run: |
          set -euo pipefail
          trap 'echo "::error::PROFILE_REG_ERROR at line $LINENO"; exit 1' ERR

          PROFILE=certs/Rentpedia_AppStore_2025.mobileprovision
          security cms -D -i "$PROFILE" > profile.plist
          UUID=$(plutil -extract UUID raw profile.plist)
          [ -n "$UUID" ] || { echo "::error::NO_PROFILE_UUID"; exit 1; }
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

          # Extract bundle identifier from profile
          BUNDLE_ID=$(plutil -extract Entitlements.application-identifier raw profile.plist | sed 's/^[^.]*\.//')
          echo "BUNDLE_IDENTIFIER=$BUNDLE_ID" >> $GITHUB_ENV

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE" \
            "$HOME/Library/MobileDevice/Provisioning Profiles/${UUID}.mobileprovision"

          echo "âœ… PROFILE_REG_SUCCESS: $UUID"
          echo "âœ… BUNDLE_ID_EXTRACTED: $BUNDLE_ID"

      # 9. Create manualâ€sign ExportOptions.plist - FIXED VERSION
      - name: Create ExportOptions.plist
        run: |
          set -euo pipefail
          trap 'echo "::error::EXPORT_OPTIONS_ERROR at line $LINENO"; exit 1' ERR

          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>signingCertificate</key>
            <string>\${{ env.CODE_SIGN_IDENTITY }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>\${{ env.BUNDLE_IDENTIFIER }}</key>
              <string>\${{ env.PROFILE_UUID }}</string>
            </dict>
            <key>uploadBitcode</key><false/>
            <key>uploadSymbols</key><true/>
            <key>compileBitcode</key><false/>
          </dict>
          </plist>
          EOF

          echo "âœ… EXPORT_OPTIONS_SUCCESS"
          echo "Using Bundle ID: ${{ env.BUNDLE_IDENTIFIER }}"

      # 10. Flutter build (no codesign)
      - name: Flutter build (no codesign)
        run: |
          set -euo pipefail
          trap 'echo "::error::FLUTTER_BUILD_ERROR at line $LINENO"; exit 1' ERR

          flutter build ios --release --no-codesign --verbose
          echo "âœ… FLUTTER_BUILD_SUCCESS"

      # 11. Archive with manual signing - IMPROVED VERSION
      - name: Archive with manual signing
        env:
          DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          CODE_SIGN_IDENTITY: ${{ env.CODE_SIGN_IDENTITY }}
          PROFILE_UUID: ${{ env.PROFILE_UUID }}
          OTHER_CODE_SIGN_FLAGS: "--keychain $HOME/Library/Keychains/build-temp.keychain-db"
        run: |
          set -euo pipefail
          trap 'echo "::error::ARCHIVE_ERROR at line $LINENO"; exit 1' ERR

          echo "Using Certificate: $CODE_SIGN_IDENTITY"
          echo "Using Profile UUID: $PROFILE_UUID"
          echo "Using Team ID: $DEVELOPMENT_TEAM"

          mkdir -p build/ios/archive
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/ios/archive/Runner.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
            PROVISIONING_PROFILE_SPECIFIER="Rentpedia_AppStore_2025" \
            OTHER_CODE_SIGN_FLAGS="$OTHER_CODE_SIGN_FLAGS" \
            -allowProvisioningUpdates \
            archive
          
          echo "âœ… ARCHIVE_SUCCESS"

      # 12. Export .ipa
      - name: Export .ipa
        run: |
          set -euo pipefail
          trap 'echo "::error::EXPORT_ARCHIVE_ERROR at line $LINENO"; exit 1' ERR

          mkdir -p build/ios/ipa
          
          echo "=== ExportOptions.plist content ==="
          cat ios/ExportOptions.plist
          
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath build/ios/ipa \
            -allowProvisioningUpdates
          
          echo "âœ… EXPORT_IPA_SUCCESS"
          
          # List generated files
          echo "=== Generated files ==="
          ls -la build/ios/ipa/

      # 13. Upload to TestFlight
      - name: Upload to TestFlight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          set -euo pipefail
          trap 'echo "::error::UPLOAD_ERROR at line $LINENO"; exit 1' ERR

          # Find the .ipa file (it might not be named exactly "Rentpedia.ipa")
          IPA_FILE=$(find build/ios/ipa -name "*.ipa" -type f | head -n1)
          [ -n "$IPA_FILE" ] || { echo "::error::NO_IPA_FOUND"; exit 1; }
          
          echo "Uploading: $IPA_FILE"

          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_FILE" \
            --username "$APPLE_ID" \
            --password "$APP_SPECIFIC_PASSWORD" \
            --verbose
          
          echo "âœ… UPLOAD_SUCCESS"

      # 14. Archive artifacts on failure
      - name: Archive build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/ios/
            ios/ExportOptions.plist
            profile.plist
          retention-days: 5