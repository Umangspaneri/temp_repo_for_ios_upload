name: iOS Build & Upload

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: stable
          cache: true

      - name: ðŸ“¦ Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          flutter pub get
          brew install cocoapods
          cd ios && pod install && cd ..
          echo "âœ… Dependencies installed"

      - name: ðŸ”§ Setup Xcode
        run: |
          echo "ðŸ”§ Setting up Xcode..."
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          echo "âœ… Xcode 16.1 selected"

      - name: ðŸ” Setup Keychain
        run: |
          echo "ðŸ” Setting up keychain..."
          security create-keychain -p "" build-temp.keychain-db
          security list-keychains -d user -s build-temp.keychain-db login.keychain
          security default-keychain -s build-temp.keychain-db
          security unlock-keychain -p "" build-temp.keychain-db
          echo "Importing Certificates.p12..."
          security import certs/Certificates.p12 -k ~/Library/Keychains/build-temp.keychain-db -P "${{ secrets.IOS_CERT_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security
          echo "Importing 27DLU45ZHK.p12..."
          security import certs/27DLU45ZHK.p12 -k ~/Library/Keychains/build-temp.keychain-db -P "${{ secrets.IOS_CERT_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security
          echo "Importing 27DLU45ZHK.cer..."
          security import certs/27DLU45ZHK.cer -k ~/Library/Keychains/build-temp.keychain-db -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple-tool:,codesign: -s -k "" ~/Library/Keychains/build-temp.keychain-db
          echo "âœ… Keychain setup complete"

      - name: ðŸ“‹ Get Certificate
        run: |
          echo "ðŸ“‹ Finding certificate..."
          echo "=== All certificates in keychain ==="
          security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db
          CERT=$(security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db | grep -E "(Distribution|Developer)" | head -n1 | sed -E 's/^[[:space:]]*[0-9]+\) [A-F0-9]+ \"(.+)\".*$/\1/')
          if [ -z "$CERT" ]; then
            echo "âŒ No distribution certificate found!"
            echo "Available certificates:"
            security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db
            exit 1
          fi
          echo "CODE_SIGN_IDENTITY=$CERT" >> $GITHUB_ENV
          echo "âœ… Certificate found: $CERT"
          CERT_HASH=$(security find-identity -p codesigning -v ~/Library/Keychains/build-temp.keychain-db | grep -E "(Distribution|Developer)" | head -n1 | sed -E 's/^[[:space:]]*[0-9]+\) ([A-F0-9]+) \"(.+)\".*$/\1/')
          echo "CERT_HASH=$CERT_HASH" >> $GITHUB_ENV
          echo "âœ… Certificate hash: $CERT_HASH"

      - name: ðŸ“± Setup Provisioning
        run: |
          echo "ðŸ“± Setting up provisioning profile..."
          security cms -D -i certs/Rentpedia_AppStore_2025.mobileprovision > profile.plist
          UUID=$(plutil -extract UUID raw profile.plist)
          BUNDLE_ID=$(plutil -extract Entitlements.application-identifier raw profile.plist | sed 's/^[^.]*\.//')
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp certs/Rentpedia_AppStore_2025.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/${UUID}.mobileprovision"
          echo "âœ… Bundle ID: $BUNDLE_ID"
          echo "âœ… Team ID (from secrets): ${{ secrets.APPLE_TEAM_ID }}" 
          echo "âœ… Profile UUID: $UUID"
          echo "âœ… Provisioning profile setup complete"

      - name: ðŸ“ Create Export Options
        run: |
          echo "ðŸ“ Creating export options..."
          cat > ios/ExportOptions.plist << 'EXPORT_EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>signingCertificate</key><string>${{ env.CODE_SIGN_IDENTITY }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${{ env.BUNDLE_ID }}</key>
              <string>${{ env.PROFILE_UUID }}</string>
            </dict>
            <key>uploadBitcode</key><false/>
            <key>uploadSymbols</key><true/>
            <key>compileBitcode</key><false/>
          </dict>
          </plist>
          EXPORT_EOF
          echo "=== Export Options ==="
          cat ios/ExportOptions.plist
          echo "âœ… Export options created"

      - name: ðŸ”¨ Flutter Build
        run: |
          echo "ðŸ”¨ Building Flutter app..."
          flutter build ios --release --no-codesign
          echo "âœ… Flutter build complete"

      - name: ðŸ“¦ Archive
        run: |
          echo "ðŸ“¦ Creating archive..."
          echo "Attempting archive with certificate name..."
          if ! xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/ios/archive/Runner.xcarchive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="${{ env.CODE_SIGN_IDENTITY }}" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_UUID }}" \
            PRODUCT_BUNDLE_IDENTIFIER="${{ env.BUNDLE_ID }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain $HOME/Library/Keychains/build-temp.keychain-db" \
            archive; then
            echo "Failed with certificate name, trying with hash..."
            xcodebuild -workspace ios/Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphoneos \
              -archivePath build/ios/archive/Runner.xcarchive \
              CODE_SIGN_STYLE=Manual \
              DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
              CODE_SIGN_IDENTITY="${{ env.CERT_HASH }}" \
              PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_UUID }}" \
              PRODUCT_BUNDLE_IDENTIFIER="${{ env.BUNDLE_ID }}" \
              OTHER_CODE_SIGN_FLAGS="--keychain $HOME/Library/Keychains/build-temp.keychain-db" \
              archive
          fi
          echo "âœ… Archive created successfully"

      - name: ðŸ“± Export IPA
        run: |
          echo "ðŸ“± Exporting IPA..."
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath build/ios/ipa
          echo "âœ… IPA exported successfully"

      - name: ðŸš€ Upload to App Store
        run: |
          echo "ðŸš€ Uploading to App Store..."
          IPA_FILE=$(find build/ios/ipa -name "*.ipa" | head -n1)
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_FILE" \
            --username "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APP_SPECIFIC_PASSWORD }}"
          echo "ðŸŽ‰ Upload successful! Your app is now processing in App Store Connect."

      - name: ðŸ’¾ Save Artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build/ios/
            ios/ExportOptions.plist